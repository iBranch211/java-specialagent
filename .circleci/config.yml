# Copyright 2020 The OpenTracing Authors
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

version: 2.1

executors:
  openjdk8:
    docker:
      - image: circleci/openjdk:8-jdk-stretch
    working_directory: /tmp/$CIRCLE_SHA1/jdk8
  openjdk11:
    docker:
      - image: circleci/openjdk:11-jdk-stretch
    working_directory: /tmp/$CIRCLE_SHA1/jdk11

cache_keys: &cache_keys
  # Reset the cache approx every release
  keys:
    - specialagent-{{ checksum "pom.xml" }}-{{ .Branch }}-{{ .Revision }}
    - specialagent-{{ checksum "pom.xml" }}-{{ .Branch }}
    - specialagent-{{ checksum "pom.xml" }}

env: &env
  steps:
    - run: export MAVEN_OPTS=-Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn
    - restore_cache:
        <<: *cache_keys

install: &install
  <<: *env
  steps:
    - checkout
    - run: pwd && ls -alF
    - run: mvn -B -P test --fail-at-end -Dsilent dependency:go-offline || true
    - save_cache:
          key: specialagent-{{ checksum "pom.xml" }}-{{ .Branch }}-{{ .Revision }}
        paths: ~/.m2
    - run: |
        mkdir -p ~/.m2
        cp settings.xml ~/.m2/settings.xml
        rm -rf ~/.m2/build ~/.m2/repository/io/opentracing/contrib/specialagent
        if [ "$CIRCLE_BRANCH" = "XXX-master-XXX" ] &&
           [ "$CIRCLE_PULL_REQUEST" = "" ]; then
          mvn -e -B -P report install &&
          mvn -e -B -DrepoToken=$REPO_TOKEN coveralls:report &&
          mvn -e -B -Dassemble install;
        else
          mvn -e -B -DskipTests install &&
          mvn -e -B -DignoreMissingTestManifest -Dassemble install;
        fi
    - persist_to_workspace:
        root: ./
        paths:
          - ./*

test: &test
  steps:
    - attach_workspace:
        at: $CIRCLE_WORKING_DIRECTORY
    - run:
        command: |
          TEST=$(circleci tests glob "test/*" | circleci tests split)
          mvn -e -B -P test -pl $TEST -amd test-compile

jobs:
  install-jdk8:
    <<: *install
    executor: openjdk8
  install-jdk11:
    <<: *install
    executor: openjdk11
  test-jdk8:
    <<: *test
    executor: openjdk8
  test-jdk11:
    <<: *test
    executor: openjdk11
  deploy:
    <<: *env
    executor: openjdk8
    steps:
      - run: export MAVEN_OPTS=-Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn
      - attach_workspace:
          at: $CIRCLE_WORKING_DIRECTORY
      - run: |
          if [ "$CIRCLE_BRANCH" = "master" ] &&
             [ "$CIRCLE_PULL_REQUEST" = "" ]; then
            eval "$SIGNING_KEY" &> /dev/null &&
            mvn -e -B -DignoreMissingTestManifest -Dassemble -P deploy install;
          fi

workflows:
  version: 2
  build-and-deploy:
    jobs:
      - install-jdk8
      - install-jdk11
      - test-jdk8:
          requires:
            - install-jdk8
      - test-jdk11:
          requires:
            - install-jdk11
      - deploy:
          requires:
            - test-jdk8
            - test-jdk11
# Copyright 2020 The OpenTracing Authors
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

version: 2.1

#executors:
#  parameters:
#    jdk:
#      type: string
#  openjdk:
#    docker:
#      - image: circleci/openjdk:<< parameters.jdk >>-stretch

cache_keys: &cache_keys
  keys: # Reset the cache approx every release
    - specialagent-{{ checksum "pom.xml" }}-{{ .Branch }}-{{ .Revision }}
    - specialagent-{{ checksum "pom.xml" }}-{{ .Branch }}
    - specialagent-{{ checksum "pom.xml" }}

jobs:
  install:
    parameters:
      jdk:
        type: string
    docker:
      - image: circleci/openjdk:<< parameters.jdk >>-stretch
    steps:
      - checkout
      - restore_cache:
          <<: *cache_keys
      - run: echo $HOME && pwd && echo $CIRCLE_WORKING_DIRECTORY && ls -alF ~
      - run: |
          mv .m2 ~ || mkdir -p ~/.m2
          rm -rf ~/.m2/repository/io/opentracing/contrib/specialagent && cp settings.xml ~/.m2/settings.xml
          mkdir -p << parameters.jdk >> && mv * << parameters.jdk >> && cd << parameters.jdk >>
          export MAVEN_OPTS="-Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn"
          mvn -B -P test --fail-at-end -Dsilent dependency:go-offline || true
          if [ "$CIRCLE_BRANCH" = "XXX-master-XXX" ] &&
             [ "$CIRCLE_PULL_REQUEST" = "" ]; then
            mvn -e -B -P report install &&
            mvn -e -B -DrepoToken=$REPO_TOKEN coveralls:report &&
            mvn -e -B -Dassemble install;
          else
            mvn -e -B -DskipTests install &&
            mvn -e -B -DignoreMissingTestManifest -Dassemble install;
          fi
          mv ~/.m2 .
          echo $HOME && pwd && echo $CIRCLE_WORKING_DIRECTORY && ls -alF ~
      - save_cache:
          key: specialagent-{{ checksum "pom.xml" }}-{{ .Branch }}-{{ .Revision }}
          paths: .m2
      - persist_to_workspace:
          root: .
          paths:
            - << parameters.jdk >>
  test:
    parameters:
      jdk:
        type: string
    docker:
      - image: circleci/openjdk:<< parameters.jdk >>-stretch
    parallelism: 4
    steps:
      - attach_workspace:
          at: .
      - run:
          command: |
            mv .m2 ~
            cd << parameters.jdk >>
            echo $HOME && pwd && echo $CIRCLE_WORKING_DIRECTORY && ls -alF ~ && ls -alF ~/.m2 && ls -alF << parameters.jdk >>
            circleci tests glob "test/*/pom.xml" | sed 's/\/pom.xml//' | awk '{print "mvn -e -B -P test -pl " $1 " -amd test-compile"}' | circleci tests split > /tmp/tests-to-run
            cat /tmp/tests-to-run
            bash -c "$(cat /tmp/tests-to-run)"
  deploy:
    parameters:
      jdk:
        type: string
    docker:
      - image: circleci/openjdk:<< parameters.jdk >>-stretch
    steps:
      - attach_workspace:
          at: .
      - run: |
          if [ "$CIRCLE_BRANCH" = "master" ] &&
             [ "$CIRCLE_PULL_REQUEST" = "" ]; then
            eval "$SIGNING_KEY" &> /dev/null &&
            export MAVEN_OPTS="-Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn" &&
            mv .m2 ~ &&
            cd << parameters.jdk >> &&
            mvn -e -B -DignoreMissingTestManifest -Dassemble -P deploy install;
          fi

workflows:
  version: 2
  build:
    jobs:
      - install:
          name: install-jdk8
          jdk: "8-jdk"
      - install:
          name: install-jdk11
          jdk: "11-jdk"
      - test:
          name: test-jdk8
          jdk: "8-jdk"
          requires:
            - install-jdk8
      - test:
          name: test-jdk11
          jdk: "11-jdk"
          requires:
            - install-jdk11
      - deploy:
          jdk: "8-jdk"
          requires:
            - test-jdk8
            - test-jdk11
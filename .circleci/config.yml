version: 2.1

executors:
  openjdk8:
    docker:
      - image: circleci/openjdk:8-jdk-stretch
    working_directory: /tmp/jdk8
  openjdk11:
    docker:
      - image: circleci/openjdk:11-jdk-stretch
    working_directory: /tmp/jdk11

install: &install
  steps:
    - checkout
    - restore_cache:
        key: cache-{{ .Branch }}-{{ checksum "pom.xml" }}
    - run: mvn dependency:go-offline
    - save_cache:
        paths:
          - ~/.m2
        key: cache-{{ .Branch }}-{{ checksum "pom.xml" }}
    - run: |
        export MAVEN_OPTS=-Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn
        mkdir -p ~/.m2
        cp settings.xml ~/.m2/settings.xml
        rm -rf ~/.m2/build ~/.m2/repository/io/opentracing/contrib/specialagent
        if [ "$CIRCLE_BRANCH" = "master" ] &&
           [ "$CIRCLE_PULL_REQUEST" = "" ]; then
          mvn -B -P report install &&
          mvn -B -DrepoToken=$REPO_TOKEN coveralls:report &&
          mvn -B -Dassemble install;
        else
          mvn -B install &&
          mvn -B -Dassemble install;
        fi
    - persist_to_workspace:
        root: /tmp
        paths:
          - ${CIRCLE_JOB}

test: &test
  steps:
    - attach_workspace:
      at: /tmp/${CIRCLE_JOB}

deploy: &deploy
  steps:
    - attach_workspace:
      at: /tmp/${CIRCLE_JOB}
    - run: |
        if [ "$TRAVIS_BRANCH" = "master" ] &&
           [ "$TRAVIS_PULL_REQUEST" = "false" ]; then
          eval "$SIGNING_KEY" &> /dev/null &&
          mvn -B -Dassemble -P deploy deploy;
        fi

jobs:
  install-jdk8:
    executor: openjdk8
    <<: *install
  install-jdk11:
    executor: openjdk11
    <<: *install
  test-jdk8:
    executor: openjdk8
    <<: *deploy

  akka-http-openjdk8:
    executor: openjdk8
    environment:
      TEST: akka-http
    <<: *test
  akka-http-openjdk11:
    executor: openjdk11
    environment:
      TEST: akka-http
    <<: *test
  apache-httpclient-openjdk8:
    executor: openjdk8
    environment:
      TEST: apache-httpclient
    <<: *test
  apache-httpclient-openjdk11:
    executor: openjdk11
    environment:
      TEST: apache-httpclient
    <<: *test
  thrift-openjdk8:
    executor: openjdk8
    environment:
      TEST: thrift
    <<: *test
  thrift-openjdk11:
    executor: openjdk11
    environment:
      TEST: thrift
    <<: *test
  asynchttpclient-openjdk8:
    executor: openjdk8
    environment:
      TEST: asynchttpclient
    <<: *test
  asynchttpclient-openjdk11:
    executor: openjdk11
    environment:
      TEST: asynchttpclient
    <<: *test
  aws-sdk-1-openjdk8:
    executor: openjdk8
    environment:
      TEST: aws-sdk-1
    <<: *test
  aws-sdk-1-openjdk11:
    executor: openjdk11
    environment:
      TEST: aws-sdk-1
    <<: *test
  aws-sdk-2-openjdk8:
    executor: openjdk8
    environment:
      TEST: aws-sdk-2
    <<: *test
  aws-sdk-2-openjdk11:
    executor: openjdk11
    environment:
      TEST: aws-sdk-2
    <<: *test
  cassandra-openjdk8:
    executor: openjdk8
    environment:
      TEST: cassandra
    <<: *test
#  cassandra-openjdk11: # This is commented out, because Cassandra does not run ok jdk11
#    executor: openjdk11
#    environment:
#      TEST: cassandra
#    <<: *test
  elasticsearch-openjdk8:
    executor: openjdk8
    environment:
      TEST: elasticsearch
    <<: *test
  elasticsearch-openjdk11:
    executor: openjdk11
    environment:
      TEST: elasticsearch
    <<: *test
  feign-openjdk8:
    executor: openjdk8
    environment:
      TEST: feign
    <<: *test
  feign-openjdk11:
    executor: openjdk11
    environment:
      TEST: feign
    <<: *test
  google-http-client-openjdk8:
    executor: openjdk8
    environment:
      TEST: google-http-client
    <<: *test
  google-http-client-openjdk11:
    executor: openjdk11
    environment:
      TEST: google-http-client
    <<: *test
  grizzly-http-client-openjdk8:
    executor: openjdk8
    environment:
      TEST: grizzly-http-client
    <<: *test
  grizzly-http-client-openjdk11:
    executor: openjdk11
    environment:
      TEST: grizzly-http-client
    <<: *test
  grizzly-http-server-openjdk8:
    executor: openjdk8
    environment:
      TEST: grizzly-http-server
    <<: *test
  grizzly-http-server-openjdk11:
    executor: openjdk11
    environment:
      TEST: grizzly-http-server
    <<: *test
  grpc-openjdk8:
    executor: openjdk8
    environment:
      TEST: grpc
    <<: *test
  grpc-openjdk11:
    executor: openjdk11
    environment:
      TEST: grpc
    <<: *test
  hazelcast-openjdk8:
    executor: openjdk8
    environment:
      TEST: hazelcast
    <<: *test
  hazelcast-openjdk11:
    executor: openjdk11
    environment:
      TEST: hazelcast
    <<: *test
  httpurlconnection-openjdk8:
    executor: openjdk8
    environment:
      TEST: httpurlconnection
    <<: *test
  httpurlconnection-openjdk11:
    executor: openjdk11
    environment:
      TEST: httpurlconnection
    <<: *test
  concurrent-openjdk8:
    executor: openjdk8
    environment:
      TEST: concurrent
    <<: *test
  concurrent-openjdk11:
    executor: openjdk11
    environment:
      TEST: concurrent
    <<: *test
  jdbc-openjdk8:
    executor: openjdk8
    environment:
      TEST: jdbc
    <<: *test
  jdbc-openjdk11:
    executor: openjdk11
    environment:
      TEST: jdbc
    <<: *test
  servlet-jetty-openjdk8:
    executor: openjdk8
    environment:
      TEST: servlet-jetty
    <<: *test
  servlet-jetty-openjdk11:
    executor: openjdk11
    environment:
      TEST: servlet-jetty
    <<: *test
  servlet-tomcat-openjdk8:
    executor: openjdk8
    environment:
      TEST: servlet-tomcat
    <<: *test
  servlet-tomcat-openjdk11:
    executor: openjdk11
    environment:
      TEST: servlet-tomcat
    <<: *test
  jaxrs-openjdk8:
    executor: openjdk8
    environment:
      TEST: jaxrs
    <<: *test
  jaxrs-openjdk11:
    executor: openjdk11
    environment:
      TEST: jaxrs
    <<: *test
  jedis-openjdk8:
    executor: openjdk8
    environment:
      TEST: jedis
    <<: *test
  jedis-openjdk11:
    executor: openjdk11
    environment:
      TEST: jedis
    <<: *test
  jms-1-openjdk8:
    executor: openjdk8
    environment:
      TEST: jms-1
    <<: *test
  jms-1-openjdk11:
    executor: openjdk11
    environment:
      TEST: jms-1
    <<: *test
  jms-2-openjdk8:
    executor: openjdk8
    environment:
      TEST: jms-2
    <<: *test
  jms-2-openjdk11:
    executor: openjdk11
    environment:
      TEST: jms-2
    <<: *test
  kafka-client-openjdk8:
    executor: openjdk8
    environment:
      TEST: kafka-client
    <<: *test
  kafka-client-openjdk11:
    executor: openjdk11
    environment:
      TEST: kafka-client
    <<: *test
  lettuce-openjdk8:
    executor: openjdk8
    environment:
      TEST: lettuce
    <<: *test
  lettuce-openjdk11:
    executor: openjdk11
    environment:
      TEST: lettuce
    <<: *test
  mongo-driver-openjdk8:
    executor: openjdk8
    environment:
      TEST: mongo-driver
    <<: *test
  mongo-driver-openjdk11:
    executor: openjdk11
    environment:
      TEST: mongo-driver
    <<: *test
  neo4j-driver-openjdk8:
    executor: openjdk8
    environment:
      TEST: neo4j-driver
    <<: *test
  neo4j-driver-openjdk11:
    executor: openjdk11
    environment:
      TEST: neo4j-driver
    <<: *test
  zuul-openjdk8:
    executor: openjdk8
    environment:
      TEST: zuul
    <<: *test
  zuul-openjdk11:
    executor: openjdk11
    environment:
      TEST: zuul
    <<: *test
  netty-openjdk8:
    executor: openjdk8
    environment:
      TEST: netty
    <<: *test
  netty-openjdk11:
    executor: openjdk11
    environment:
      TEST: netty
    <<: *test
  okhttp-openjdk8:
    executor: openjdk8
    environment:
      TEST: okhttp
    <<: *test
  okhttp-openjdk11:
    executor: openjdk11
    environment:
      TEST: okhttp
    <<: *test
  play-openjdk8:
    executor: openjdk8
    environment:
      TEST: play
    <<: *test
  play-openjdk11:
    executor: openjdk11
    environment:
      TEST: play
    <<: *test
  play-ws-openjdk8:
    executor: openjdk8
    environment:
      TEST: play-ws
    <<: *test
  play-ws-openjdk11:
    executor: openjdk11
    environment:
      TEST: play-ws
    <<: *test
  rabbitmq-client-openjdk8:
    executor: openjdk8
    environment:
      TEST: rabbitmq-client
    <<: *test
  rabbitmq-client-openjdk11:
    executor: openjdk11
    environment:
      TEST: rabbitmq-client
    <<: *test
  reactor-openjdk8:
    executor: openjdk8
    environment:
      TEST: reactor
    <<: *test
  reactor-openjdk11:
    executor: openjdk11
    environment:
      TEST: reactor
    <<: *test
  redisson-openjdk8:
    executor: openjdk8
    environment:
      TEST: redisson
    <<: *test
  redisson-openjdk11:
    executor: openjdk11
    environment:
      TEST: redisson
    <<: *test
  rxjava-openjdk8:
    executor: openjdk8
    environment:
      TEST: rxjava
    <<: *test
  rxjava-openjdk11:
    executor: openjdk11
    environment:
      TEST: rxjava
    <<: *test
  spring-jms-openjdk8:
    executor: openjdk8
    environment:
      TEST: spring-jms
    <<: *test
  spring-jms-openjdk11:
    executor: openjdk11
    environment:
      TEST: spring-jms
    <<: *test
  spring-kafka-openjdk8:
    executor: openjdk8
    environment:
      TEST: spring-kafka
    <<: *test
  spring-kafka-openjdk11:
    executor: openjdk11
    environment:
      TEST: spring-kafka
    <<: *test
  spring-messaging-openjdk8:
    executor: openjdk8
    environment:
      TEST: spring-messaging
    <<: *test
  spring-messaging-openjdk11:
    executor: openjdk11
    environment:
      TEST: spring-messaging
    <<: *test
  spring-rabbitmq-openjdk8:
    executor: openjdk8
    environment:
      TEST: spring-rabbitmq
    <<: *test
  spring-rabbitmq-openjdk11:
    executor: openjdk11
    environment:
      TEST: spring-rabbitmq
    <<: *test
  spring-scheduling-openjdk8:
    executor: openjdk8
    environment:
      TEST: spring-scheduling
    <<: *test
  spring-scheduling-openjdk11:
    executor: openjdk11
    environment:
      TEST: spring-scheduling
    <<: *test
  spring-web-openjdk8:
    executor: openjdk8
    environment:
      TEST: spring-web
    <<: *test
  spring-web-openjdk11:
    executor: openjdk11
    environment:
      TEST: spring-web
    <<: *test
  spring-webmvc-openjdk8:
    executor: openjdk8
    environment:
      TEST: spring-webmvc
    <<: *test
  spring-webmvc-openjdk11:
    executor: openjdk11
    environment:
      TEST: spring-webmvc
    <<: *test
  spring-webflux-openjdk8:
    executor: openjdk8
    environment:
      TEST: spring-webflux
    <<: *test
  spring-webflux-openjdk11:
    executor: openjdk11
    environment:
      TEST: spring-webflux
    <<: *test
  spring-websocket-openjdk8:
    executor: openjdk8
    environment:
      TEST: spring-websocket
    <<: *test
  spring-websocket-openjdk11:
    executor: openjdk11
    environment:
      TEST: spring-websocket
    <<: *test
  spymemcached-openjdk8:
    executor: openjdk8
    environment:
      TEST: spymemcached
    <<: *test
  spymemcached-openjdk11:
    executor: openjdk11
    environment:
      TEST: spymemcached

workflows:
  version: 2
  build-and-deploy:
    jobs:
      - install-jdk8
      - install-jdk11
      - akka-http-openjdk8:
          requires:
            - install-jdk8
      - akka-http-openjdk11:
          requires:
            - install-jdk11
      - apache-httpclient-openjdk8:
          requires:
            - install-jdk8
      - apache-httpclient-openjdk11:
          requires:
            - install-jdk11
      - thrift-openjdk8:
          requires:
            - install-jdk8
      - thrift-openjdk11:
          requires:
            - install-jdk11
      - asynchttpclient-openjdk8:
          requires:
            - install-jdk8
      - asynchttpclient-openjdk11:
          requires:
            - install-jdk11
      - aws-sdk-1-openjdk8:
          requires:
            - install-jdk8
      - aws-sdk-1-openjdk11:
          requires:
            - install-jdk11
      - aws-sdk-2-openjdk8:
          requires:
            - install-jdk8
      - aws-sdk-2-openjdk11:
          requires:
            - install-jdk11
      - cassandra-openjdk8:
          requires:
            - install-jdk8
      - elasticsearch-openjdk8:
          requires:
            - install-jdk8
      - elasticsearch-openjdk11:
          requires:
            - install-jdk11
      - feign-openjdk8:
          requires:
            - install-jdk8
      - feign-openjdk11:
          requires:
            - install-jdk11
      - google-http-client-openjdk8:
          requires:
            - install-jdk8
      - google-http-client-openjdk11:
          requires:
            - install-jdk11
      - grizzly-http-client-openjdk8:
          requires:
            - install-jdk8
      - grizzly-http-client-openjdk11:
          requires:
            - install-jdk11
      - grizzly-http-server-openjdk8:
          requires:
            - install-jdk8
      - grizzly-http-server-openjdk11:
          requires:
            - install-jdk11
      - grpc-openjdk8:
          requires:
            - install-jdk8
      - grpc-openjdk11:
          requires:
            - install-jdk11
      - hazelcast-openjdk8:
          requires:
            - install-jdk8
      - hazelcast-openjdk11:
          requires:
            - install-jdk11
      - httpurlconnection-openjdk8:
          requires:
            - install-jdk8
      - httpurlconnection-openjdk11:
          requires:
            - install-jdk11
      - concurrent-openjdk8:
          requires:
            - install-jdk8
      - concurrent-openjdk11:
          requires:
            - install-jdk11
      - jdbc-openjdk8:
          requires:
            - install-jdk8
      - jdbc-openjdk11:
          requires:
            - install-jdk11
      - servlet-jetty-openjdk8:
          requires:
            - install-jdk8
      - servlet-jetty-openjdk11:
          requires:
            - install-jdk11
      - servlet-tomcat-openjdk8:
          requires:
            - install-jdk8
      - servlet-tomcat-openjdk11:
          requires:
            - install-jdk11
      - jaxrs-openjdk8:
          requires:
            - install-jdk8
      - jaxrs-openjdk11:
          requires:
            - install-jdk11
      - jedis-openjdk8:
          requires:
            - install-jdk8
      - jedis-openjdk11:
          requires:
            - install-jdk11
      - jms-1-openjdk8:
          requires:
            - install-jdk8
      - jms-1-openjdk11:
          requires:
            - install-jdk11
      - jms-2-openjdk8:
          requires:
            - install-jdk8
      - jms-2-openjdk11:
          requires:
            - install-jdk11
      - kafka-client-openjdk8:
          requires:
            - install-jdk8
      - kafka-client-openjdk11:
          requires:
            - install-jdk11
      - lettuce-openjdk8:
          requires:
            - install-jdk8
      - lettuce-openjdk11:
          requires:
            - install-jdk11
      - mongo-driver-openjdk8:
          requires:
            - install-jdk8
      - mongo-driver-openjdk11:
          requires:
            - install-jdk11
      - neo4j-driver-openjdk8:
          requires:
            - install-jdk8
      - neo4j-driver-openjdk11:
          requires:
            - install-jdk11
      - zuul-openjdk8:
          requires:
            - install-jdk8
      - zuul-openjdk11:
          requires:
            - install-jdk11
      - netty-openjdk8:
          requires:
            - install-jdk8
      - netty-openjdk11:
          requires:
            - install-jdk11
      - okhttp-openjdk8:
          requires:
            - install-jdk8
      - okhttp-openjdk11:
          requires:
            - install-jdk11
      - play-openjdk8:
          requires:
            - install-jdk8
      - play-openjdk11:
          requires:
            - install-jdk11
      - play-ws-openjdk8:
          requires:
            - install-jdk8
      - play-ws-openjdk11:
          requires:
            - install-jdk11
      - rabbitmq-client-openjdk8:
          requires:
            - install-jdk8
      - rabbitmq-client-openjdk11:
          requires:
            - install-jdk11
      - reactor-openjdk8:
          requires:
            - install-jdk8
      - reactor-openjdk11:
          requires:
            - install-jdk11
      - redisson-openjdk8:
          requires:
            - install-jdk8
      - redisson-openjdk11:
          requires:
            - install-jdk11
      - rxjava-openjdk8:
          requires:
            - install-jdk8
      - rxjava-openjdk11:
          requires:
            - install-jdk11
      - spring-jms-openjdk8:
          requires:
            - install-jdk8
      - spring-jms-openjdk11:
          requires:
            - install-jdk11
      - spring-kafka-openjdk8:
          requires:
            - install-jdk8
      - spring-kafka-openjdk11:
          requires:
            - install-jdk11
      - spring-messaging-openjdk8:
          requires:
            - install-jdk8
      - spring-messaging-openjdk11:
          requires:
            - install-jdk11
      - spring-rabbitmq-openjdk8:
          requires:
            - install-jdk8
      - spring-rabbitmq-openjdk11:
          requires:
            - install-jdk11
      - spring-scheduling-openjdk8:
          requires:
            - install-jdk8
      - spring-scheduling-openjdk11:
          requires:
            - install-jdk11
      - spring-web-openjdk8:
          requires:
            - install-jdk8
      - spring-web-openjdk11:
          requires:
            - install-jdk11
      - spring-webmvc-openjdk8:
          requires:
            - install-jdk8
      - spring-webmvc-openjdk11:
          requires:
            - install-jdk11
      - spring-webflux-openjdk8:
          requires:
            - install-jdk8
      - spring-webflux-openjdk11:
          requires:
            - install-jdk11
      - spring-websocket-openjdk8:
          requires:
            - install-jdk8
      - spring-websocket-openjdk11:
          requires:
            - install-jdk11
      - spymemcached-openjdk8:
          requires:
            - install-jdk8
      - spymemcached-openjdk11:
          requires:
            - install-jdk11
      - deploy:
          requires:
            - akka-http-openjdk8
            - akka-http-openjdk11
            - apache-httpclient-openjdk8
            - apache-httpclient-openjdk11
            - thrift-openjdk8
            - thrift-openjdk11
            - asynchttpclient-openjdk8
            - asynchttpclient-openjdk11
            - aws-sdk-1-openjdk8
            - aws-sdk-1-openjdk11
            - aws-sdk-2-openjdk8
            - aws-sdk-2-openjdk11
            - cassandra-openjdk8
            - elasticsearch-openjdk8
            - elasticsearch-openjdk11
            - feign-openjdk8
            - feign-openjdk11
            - google-http-client-openjdk8
            - google-http-client-openjdk11
            - grizzly-http-client-openjdk8
            - grizzly-http-client-openjdk11
            - grizzly-http-server-openjdk8
            - grizzly-http-server-openjdk11
            - grpc-openjdk8
            - grpc-openjdk11
            - hazelcast-openjdk8
            - hazelcast-openjdk11
            - httpurlconnection-openjdk8
            - httpurlconnection-openjdk11
            - concurrent-openjdk8
            - concurrent-openjdk11
            - jdbc-openjdk8
            - jdbc-openjdk11
            - servlet-jetty-openjdk8
            - servlet-jetty-openjdk11
            - servlet-tomcat-openjdk8
            - servlet-tomcat-openjdk11
            - jaxrs-openjdk8
            - jaxrs-openjdk11
            - jedis-openjdk8
            - jedis-openjdk11
            - jms-1-openjdk8
            - jms-1-openjdk11
            - jms-2-openjdk8
            - jms-2-openjdk11
            - kafka-client-openjdk8
            - kafka-client-openjdk11
            - lettuce-openjdk8
            - lettuce-openjdk11
            - mongo-driver-openjdk8
            - mongo-driver-openjdk11
            - neo4j-driver-openjdk8
            - neo4j-driver-openjdk11
            - zuul-openjdk8
            - zuul-openjdk11
            - netty-openjdk8
            - netty-openjdk11
            - okhttp-openjdk8
            - okhttp-openjdk11
            - play-openjdk8
            - play-openjdk11
            - play-ws-openjdk8
            - play-ws-openjdk11
            - rabbitmq-client-openjdk8
            - rabbitmq-client-openjdk11
            - reactor-openjdk8
            - reactor-openjdk11
            - redisson-openjdk8
            - redisson-openjdk11
            - rxjava-openjdk8
            - rxjava-openjdk11
            - spring-jms-openjdk8
            - spring-jms-openjdk11
            - spring-kafka-openjdk8
            - spring-kafka-openjdk11
            - spring-messaging-openjdk8
            - spring-messaging-openjdk11
            - spring-rabbitmq-openjdk8
            - spring-rabbitmq-openjdk11
            - spring-scheduling-openjdk8
            - spring-scheduling-openjdk11
            - spring-web-openjdk8
            - spring-web-openjdk11
            - spring-webmvc-openjdk8
            - spring-webmvc-openjdk11
            - spring-webflux-openjdk8
            - spring-webflux-openjdk11
            - spring-websocket-openjdk8
            - spring-websocket-openjdk11
            - spymemcached-openjdk8
            - spymemcached-openjdk11